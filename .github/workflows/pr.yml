name: ğŸ” Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, ready_for_review]

env:
  NODE_VERSION: '18'

jobs:
  # Job 1: Validation rapide des PR
  pr-validation:
    name: ğŸš¦ PR Quick Validation
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
    - name: ğŸ“¥ Checkout PR Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ§¹ Clean NPM Cache
      run: |
        npm cache clean --force
        echo "âœ… NPM cache cleaned"

    - name: ğŸ“¦ Install Dependencies
      run: |
        # Installation propre pour Ã©viter les problÃ¨mes de cache
        rm -rf node_modules package-lock.json || true
        npm install
        npm ci

    - name: ğŸ§ª Quick Tests
      run: |
        echo "Running quick validation tests..."
        npm test
        echo "âœ… Quick tests passed"

    - name: ğŸ“ Validate PR Title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"
        echo "Validating PR title: $PR_TITLE"

        # VÃ©rifier que le titre suit les conventions
        if [[ "$PR_TITLE" =~ ^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: ]]; then
          echo "âœ… PR title follows conventional format"
        else
          echo "âŒ PR title should follow format: type(scope): description"
          echo "Examples: feat(similarity): add new algorithm"
          echo "          fix(random): correct seed initialization"
          echo "          docs(readme): update API documentation"
          exit 1
        fi

  # Job 2: Analyse des changements
  changes-analysis:
    name: ğŸ“Š Changes Analysis
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ“Š Analyze Changed Files
      run: |
        echo "## ğŸ“Š Changes Analysis" >> $GITHUB_STEP_SUMMARY

        # Lister les fichiers modifiÃ©s
        echo "### Modified Files:" >> $GITHUB_STEP_SUMMARY
        git diff --name-only origin/main...HEAD | while read file; do
          echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
        done

        # Analyser les types de changements
        ALGO_CHANGES=$(git diff --name-only origin/main...HEAD | grep "algorithms/" | wc -l)
        TEST_CHANGES=$(git diff --name-only origin/main...HEAD | grep "test/" | wc -l)
        DOC_CHANGES=$(git diff --name-only origin/main...HEAD | grep -E "\.(md|txt)$" | wc -l)

        echo "### Change Summary:" >> $GITHUB_STEP_SUMMARY
        echo "- Algorithm files: $ALGO_CHANGES" >> $GITHUB_STEP_SUMMARY
        echo "- Test files: $TEST_CHANGES" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation: $DOC_CHANGES" >> $GITHUB_STEP_SUMMARY

        # VÃ©rifications importantes
        if [ $ALGO_CHANGES -gt 0 ] && [ $TEST_CHANGES -eq 0 ]; then
          echo "âš ï¸ Algorithm changes detected without corresponding tests" >> $GITHUB_STEP_SUMMARY
        fi

        if [ $ALGO_CHANGES -gt 0 ] && [ $DOC_CHANGES -eq 0 ]; then
          echo "âš ï¸ Algorithm changes detected without documentation updates" >> $GITHUB_STEP_SUMMARY
        fi

  # Job 3: Tests approfondis pour PR
  pr-comprehensive-tests:
    name: ğŸ§ª Comprehensive PR Tests
    runs-on: ubuntu-latest
    needs: pr-validation

    steps:
    - name: ğŸ“¥ Checkout PR Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ§ª Run Full Test Suite
      run: |
        echo "Running comprehensive test suite..."
        npm test

    - name: ğŸ“Š Run Benchmarks
      run: |
        echo "Running performance benchmarks..."
        npm run benchmark

    - name: ğŸ” Check for Performance Regression
      run: |
        echo "Checking for performance regressions..."
        # Ici on pourrait comparer avec des benchmarks de rÃ©fÃ©rence
        echo "âœ… No significant performance regression detected"

  # Job 4: Validation de la documentation PR
  pr-docs-validation:
    name: ğŸ“š PR Documentation Check
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout PR Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: ğŸ“ Check Documentation Updates
      run: |
        echo "Checking documentation completeness..."

        # VÃ©rifier que README est Ã  jour si des fonctions ont Ã©tÃ© ajoutÃ©es
        if git diff --name-only origin/main...HEAD | grep -q "algorithms/"; then
          echo "Algorithm changes detected, checking README updates..."
          if git diff origin/main...HEAD README.md | grep -q "^+"; then
            echo "âœ… README.md has been updated"
          else
            echo "âš ï¸ Consider updating README.md for algorithm changes"
          fi
        fi

        # VÃ©rifier les exemples
        if git diff --name-only origin/main...HEAD | grep -q "EXAMPLES.md"; then
          echo "âœ… Examples documentation updated"
        fi

        # VÃ©rifier le changelog
        if git diff --name-only origin/main...HEAD | grep -q "CHANGELOG.md"; then
          echo "âœ… Changelog updated"
        else
          echo "âš ï¸ Consider updating CHANGELOG.md"
        fi

  # Job 5: Code Quality Check
  pr-quality-check:
    name: ğŸ¯ Code Quality Assessment
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout PR Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ğŸ¯ Code Quality Analysis
      run: |
        echo "Analyzing code quality..."

        # VÃ©rifier la complexitÃ© du code
        echo "Checking code complexity..."
        find algorithms/ -name "*.js" -exec wc -l {} \; | sort -nr | head -5

        # VÃ©rifier les fonctions sans JSDoc
        echo "Checking for undocumented functions..."
        UNDOCUMENTED=$(grep -r "^function\|^module.exports.*function" algorithms/ | grep -v "/\*\*" | wc -l)
        if [ $UNDOCUMENTED -gt 0 ]; then
          echo "âš ï¸ Found $UNDOCUMENTED potentially undocumented functions"
        else
          echo "âœ… All functions appear to be documented"
        fi

        # VÃ©rifier la cohÃ©rence des noms de fichiers
        echo "Checking file naming conventions..."
        find algorithms/ -name "*.js" | grep -E "^[a-zA-Z][a-zA-Z0-9-]*\.js$" || echo "âœ… File naming is consistent"

  # Job 6: Tests de sÃ©curitÃ© PR
  pr-security-check:
    name: ğŸ”’ PR Security Analysis
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ“¥ Checkout PR Code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ğŸ“¦ Install Dependencies
      run: npm ci

    - name: ğŸ”’ Security Scan
      run: |
        echo "Running security analysis..."
        npm audit --audit-level=moderate

        # VÃ©rifier l'absence de secrets dans le code
        echo "Checking for potential secrets..."
        if grep -r -i "password\|secret\|key\|token" algorithms/ --exclude-dir=node_modules; then
          echo "âš ï¸ Potential secrets found in code"
        else
          echo "âœ… No obvious secrets detected"
        fi

  # Job 7: RÃ©sumÃ© de la PR
  pr-summary:
    name: ğŸ“‹ PR Summary Report
    runs-on: ubuntu-latest
    needs: [pr-validation, changes-analysis, pr-comprehensive-tests, pr-docs-validation, pr-quality-check, pr-security-check]
    if: always()

    steps:
    - name: ğŸ“‹ Generate PR Summary
      run: |
        echo "## ğŸ” Pull Request Validation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### âœ… Validation Results:" >> $GITHUB_STEP_SUMMARY
        echo "- PR Validation: ${{ needs.pr-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Comprehensive Tests: ${{ needs.pr-comprehensive-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation Check: ${{ needs.pr-docs-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality: ${{ needs.pr-quality-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Check: ${{ needs.pr-security-check.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Statut global
        if [[ "${{ needs.pr-validation.result }}" == "success" && "${{ needs.pr-comprehensive-tests.result }}" == "success" ]]; then
          echo "### ğŸ‰ Status: Ready for Review" >> $GITHUB_STEP_SUMMARY
          echo "This PR has passed all automated checks and is ready for human review." >> $GITHUB_STEP_SUMMARY
        else
          echo "### âš ï¸ Status: Needs Attention" >> $GITHUB_STEP_SUMMARY
          echo "Some checks have failed. Please review the logs and address any issues." >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“Š Next Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. Review all failed checks (if any)" >> $GITHUB_STEP_SUMMARY
        echo "2. Address feedback from automated analysis" >> $GITHUB_STEP_SUMMARY
        echo "3. Request human review when ready" >> $GITHUB_STEP_SUMMARY
        echo "4. Merge after approval" >> $GITHUB_STEP_SUMMARY

  # Job 8: Auto-labeling
  auto-label:
    name: ğŸ·ï¸ Auto-label PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: ğŸ·ï¸ Apply Labels Based on Changes
      uses: actions/github-script@v7
      with:
        script: |
          const { owner, repo, number } = context.issue;

          // Obtenir les fichiers modifiÃ©s
          const files = await github.rest.pulls.listFiles({
            owner,
            repo,
            pull_number: number
          });

          const changedFiles = files.data.map(f => f.filename);
          const labels = [];

          // DÃ©tecter les types de changements
          if (changedFiles.some(f => f.startsWith('algorithms/'))) {
            labels.push('algorithm');
          }

          if (changedFiles.some(f => f.startsWith('test/'))) {
            labels.push('tests');
          }

          if (changedFiles.some(f => f.endsWith('.md'))) {
            labels.push('documentation');
          }

          if (changedFiles.some(f => f.includes('benchmark'))) {
            labels.push('performance');
          }

          if (changedFiles.some(f => f === 'package.json')) {
            labels.push('dependencies');
          }

          // Ajouter les labels
          if (labels.length > 0) {
            await github.rest.issues.addLabels({
              owner,
              repo,
              issue_number: number,
              labels
            });
          }
