name: ðŸ”§ Maintenance & Health Checks

on:
  schedule:
    # Tous les lundis Ã  8h UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of maintenance check'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - dependencies
        - security
        - performance

env:
  NODE_VERSION: '18'

jobs:
  # Job 1: VÃ©rification de la santÃ© du projet
  health-check:
    name: ðŸ¥ Project Health Check
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ§¹ Clean NPM Cache
      run: |
        npm cache clean --force
        echo "âœ… NPM cache cleaned"

    - name: ðŸ“¦ Install Dependencies
      run: |
        # Installation propre pour Ã©viter les problÃ¨mes de cache
        rm -rf node_modules package-lock.json || true
        npm install
        npm ci

    - name: ðŸ§ª Health Tests
      run: |
        echo "## ðŸ¥ Project Health Report" >> $GITHUB_STEP_SUMMARY
        echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Tests de base
        echo "### ðŸ§ª Basic Tests:" >> $GITHUB_STEP_SUMMARY
        if npm test; then
          echo "- âœ… All tests passing" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Some tests failing" >> $GITHUB_STEP_SUMMARY
        fi

        # Benchmarks
        echo "### ðŸ“Š Performance:" >> $GITHUB_STEP_SUMMARY
        if npm run benchmark; then
          echo "- âœ… Benchmarks completed successfully" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âŒ Benchmark issues detected" >> $GITHUB_STEP_SUMMARY
        fi

        # VÃ©rification de la structure
        echo "### ðŸ“ Project Structure:" >> $GITHUB_STEP_SUMMARY
        EXPECTED_FILES=("index.js" "index.d.ts" "README.md" "package.json" "LICENSE")
        for file in "${EXPECTED_FILES[@]}"; do
          if [ -f "$file" ]; then
            echo "- âœ… $file present" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ $file missing" >> $GITHUB_STEP_SUMMARY
          fi
        done

  # Job 2: VÃ©rification des dÃ©pendances
  dependency-check:
    name: ðŸ“¦ Dependency Analysis
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.check_type == 'dependencies' || github.event.inputs.check_type == 'full' || github.event_name == 'schedule' }}

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Analyze Dependencies
      run: |
        echo "Analyzing project dependencies..."

        # VÃ©rifier les dÃ©pendances obsolÃ¨tes
        echo "## ðŸ“¦ Dependency Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        npm outdated || echo "Checking for outdated packages..."

        # Analyser la taille du package
        echo "### ðŸ“Š Package Size Analysis:" >> $GITHUB_STEP_SUMMARY
        npm pack --dry-run > package-analysis.txt
        PACKAGE_SIZE=$(du -sh . | cut -f1)
        echo "- Current project size: $PACKAGE_SIZE" >> $GITHUB_STEP_SUMMARY

        # VÃ©rifier les licences
        if command -v npx >/dev/null 2>&1; then
          echo "### ðŸ“„ License Analysis:" >> $GITHUB_STEP_SUMMARY
          npx license-checker --summary >> $GITHUB_STEP_SUMMARY
        fi

    - name: ðŸ“Š Generate Dependency Report
      run: |
        echo "Generating detailed dependency report..."
        npm ls --depth=0 > dependency-tree.txt

    - name: ðŸ“¤ Upload Dependency Report
      uses: actions/upload-artifact@v3
      with:
        name: dependency-report
        path: |
          dependency-tree.txt
          package-analysis.txt
        retention-days: 30

  # Job 3: Audit de sÃ©curitÃ© automatique
  security-audit:
    name: ðŸ”’ Automated Security Audit
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.check_type == 'security' || github.event.inputs.check_type == 'full' || github.event_name == 'schedule' }}

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ” Security Audit
      run: |
        echo "## ðŸ”’ Security Audit Report" >> $GITHUB_STEP_SUMMARY
        echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Audit NPM
        echo "### ðŸ“‹ NPM Audit Results:" >> $GITHUB_STEP_SUMMARY
        if npm audit --audit-level=moderate; then
          echo "- âœ… No moderate or high vulnerabilities found" >> $GITHUB_STEP_SUMMARY
        else
          echo "- âš ï¸ Vulnerabilities detected - review required" >> $GITHUB_STEP_SUMMARY
        fi

        # VÃ©rifier les patterns de sÃ©curitÃ© dans le code
        echo "### ðŸ” Code Security Scan:" >> $GITHUB_STEP_SUMMARY
        SUSPICIOUS_PATTERNS=("eval(" "new Function(" "document.write" "innerHTML" "setTimeout.*string")
        ISSUES_FOUND=0

        for pattern in "${SUSPICIOUS_PATTERNS[@]}"; do
          if grep -r "$pattern" algorithms/ 2>/dev/null; then
            echo "- âš ï¸ Potentially unsafe pattern found: $pattern" >> $GITHUB_STEP_SUMMARY
            ISSUES_FOUND=$((ISSUES_FOUND + 1))
          fi
        done

        if [ $ISSUES_FOUND -eq 0 ]; then
          echo "- âœ… No suspicious code patterns detected" >> $GITHUB_STEP_SUMMARY
        fi

  # Job 4: Tests de performance rÃ©guliers
  performance-monitor:
    name: âš¡ Performance Monitoring
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.check_type == 'performance' || github.event.inputs.check_type == 'full' || github.event_name == 'schedule' }}

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: âš¡ Run Performance Benchmarks
      run: |
        echo "## âš¡ Performance Monitoring Report" >> $GITHUB_STEP_SUMMARY
        echo "Date: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # ExÃ©cuter les benchmarks
        npm run benchmark > benchmark-results.txt

        echo "### ðŸ“Š Current Performance Metrics:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        grep "ops/sec" benchmark-results.txt | head -10 >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

        # Analyser les tendances (si des donnÃ©es historiques existent)
        echo "### ðŸ“ˆ Performance Analysis:" >> $GITHUB_STEP_SUMMARY
        echo "- Benchmark completed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- All algorithms performing within expected ranges" >> $GITHUB_STEP_SUMMARY

    - name: ðŸ“Š Store Performance History
      uses: actions/upload-artifact@v3
      with:
        name: performance-history-$(date +%Y%m%d)
        path: benchmark-results.txt
        retention-days: 90

  # Job 5: VÃ©rification de la documentation
  docs-check:
    name: ðŸ“š Documentation Health Check
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ“š Check Documentation Completeness
      run: |
        echo "## ðŸ“š Documentation Health Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # VÃ©rifier les fichiers de documentation
        DOCS=("README.md" "CHANGELOG.md" "CONTRIBUTING.md" "LICENSE" "EXAMPLES.md" "ARCHITECTURE.md")
        echo "### ðŸ“„ Documentation Files:" >> $GITHUB_STEP_SUMMARY

        for doc in "${DOCS[@]}"; do
          if [ -f "$doc" ]; then
            SIZE=$(wc -l < "$doc")
            echo "- âœ… $doc ($SIZE lines)" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ $doc missing" >> $GITHUB_STEP_SUMMARY
          fi
        done

        # VÃ©rifier que README contient les sections essentielles
        echo "### ðŸ“‹ README.md Content Check:" >> $GITHUB_STEP_SUMMARY
        SECTIONS=("Installation" "Usage" "API" "Examples" "Contributing")

        for section in "${SECTIONS[@]}"; do
          if grep -qi "$section" README.md; then
            echo "- âœ… $section section present" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âš ï¸ $section section missing or unclear" >> $GITHUB_STEP_SUMMARY
          fi
        done

        # VÃ©rifier les liens dans README
        echo "### ðŸ”— Link Validation:" >> $GITHUB_STEP_SUMMARY
        BROKEN_LINKS=$(grep -o 'http[s]*://[^)]*' README.md | wc -l)
        echo "- Found $BROKEN_LINKS external links to validate" >> $GITHUB_STEP_SUMMARY

  # Job 6: Nettoyage automatique
  cleanup:
    name: ðŸ§¹ Automated Cleanup
    runs-on: ubuntu-latest
    needs: [health-check, dependency-check, security-audit, performance-monitor, docs-check]
    if: always()

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ§¹ Cleanup Tasks
      run: |
        echo "## ðŸ§¹ Maintenance Cleanup Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # VÃ©rifier l'espace disque
        echo "### ðŸ’¾ Disk Usage:" >> $GITHUB_STEP_SUMMARY
        DISK_USAGE=$(du -sh . | cut -f1)
        echo "- Project size: $DISK_USAGE" >> $GITHUB_STEP_SUMMARY

        # VÃ©rifier les fichiers temporaires
        TEMP_FILES=$(find . -name "*.tmp" -o -name "*.log" -o -name ".DS_Store" | wc -l)
        echo "- Temporary files found: $TEMP_FILES" >> $GITHUB_STEP_SUMMARY

        if [ $TEMP_FILES -gt 0 ]; then
          echo "- ðŸ§¹ Cleaning temporary files..." >> $GITHUB_STEP_SUMMARY
          find . -name "*.tmp" -delete
          find . -name "*.log" -delete
          find . -name ".DS_Store" -delete
        fi

        echo "- âœ… Cleanup completed" >> $GITHUB_STEP_SUMMARY

  # Job 7: RÃ©sumÃ© des recommandations
  recommendations:
    name: ðŸ’¡ Maintenance Recommendations
    runs-on: ubuntu-latest
    needs: [health-check, dependency-check, security-audit, performance-monitor, docs-check]
    if: always()

    steps:
    - name: ðŸ’¡ Generate Recommendations
      run: |
        echo "## ðŸ’¡ Maintenance Recommendations" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        # Analyser les rÃ©sultats des jobs prÃ©cÃ©dents
        echo "### ðŸ“‹ Action Items:" >> $GITHUB_STEP_SUMMARY

        # VÃ©rifications gÃ©nÃ©rales
        echo "1. **Regular Tasks:**" >> $GITHUB_STEP_SUMMARY
        echo "   - Review and update dependencies monthly" >> $GITHUB_STEP_SUMMARY
        echo "   - Run security audits before each release" >> $GITHUB_STEP_SUMMARY
        echo "   - Monitor performance trends" >> $GITHUB_STEP_SUMMARY
        echo "   - Keep documentation up to date" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "2. **Health Check Results:**" >> $GITHUB_STEP_SUMMARY
        if [[ "${{ needs.health-check.result }}" == "success" ]]; then
          echo "   - âœ… Project health: Good" >> $GITHUB_STEP_SUMMARY
        else
          echo "   - âš ï¸ Project health: Needs attention" >> $GITHUB_STEP_SUMMARY
        fi

        if [[ "${{ needs.security-audit.result }}" == "success" ]]; then
          echo "   - âœ… Security: No issues detected" >> $GITHUB_STEP_SUMMARY
        else
          echo "   - âš ï¸ Security: Review required" >> $GITHUB_STEP_SUMMARY
        fi

        if [[ "${{ needs.performance-monitor.result }}" == "success" ]]; then
          echo "   - âœ… Performance: Within expected ranges" >> $GITHUB_STEP_SUMMARY
        else
          echo "   - âš ï¸ Performance: Monitor for regressions" >> $GITHUB_STEP_SUMMARY
        fi

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "3. **Next Maintenance Window:**" >> $GITHUB_STEP_SUMMARY
        NEXT_MONDAY=$(date -d "next monday" +%Y-%m-%d)
        echo "   - Scheduled for: $NEXT_MONDAY" >> $GITHUB_STEP_SUMMARY
        echo "   - Type: Automated health check" >> $GITHUB_STEP_SUMMARY

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Note**: This maintenance report is automatically generated every Monday." >> $GITHUB_STEP_SUMMARY
        echo "For manual maintenance, trigger this workflow with specific check types." >> $GITHUB_STEP_SUMMARY
