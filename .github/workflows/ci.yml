name: ðŸš€ CI/CD Pipeline - Algorith

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  NODE_VERSION: '18'
  CACHE_VERSION: 'v1'

jobs:
  # Job 1: Tests et Validation
  test:
    name: ðŸ§ª Tests & Quality Checks
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [14, 16, 18, 20]

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: |
        npm ci
        npm ls # VÃ©rifier la santÃ© des dÃ©pendances

    - name: ðŸ” Lint & Format Check
      run: |
        # VÃ©rifier que les fichiers sont bien formatÃ©s
        echo "Checking file formatting..."
        find . -name "*.js" -not -path "./node_modules/*" | wc -l

    - name: ðŸ§ª Run Unit Tests
      run: |
        npm test
        echo "âœ… All tests passed for Node.js ${{ matrix.node-version }}"

    - name: ðŸ“Š Run Benchmarks
      run: |
        echo "Running performance benchmarks..."
        npm run benchmark
        echo "âœ… Benchmarks completed successfully"

    - name: ðŸ“ˆ Upload Test Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results-node-${{ matrix.node-version }}
        path: |
          benchmark-results.json
          test-results/
        retention-days: 30

  # Job 2: Analyse de Couverture de Code
  coverage:
    name: ðŸ“Š Code Coverage
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ§ª Run Coverage Tests
      run: |
        npm run test:coverage
        echo "âœ… Coverage analysis completed"

    - name: ðŸ“¤ Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/lcov.info
        flags: unittests
        name: algorith-coverage
        fail_ci_if_error: false

  # Job 3: Analyse de SÃ©curitÃ©
  security:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ” NPM Security Audit
      run: |
        npm audit --audit-level=moderate
        echo "âœ… Security audit completed"

    - name: ðŸ” Check for Vulnerable Dependencies
      run: |
        npx audit-ci --moderate
        echo "âœ… Vulnerability check completed"

  # Job 4: Validation de la Documentation
  docs:
    name: ðŸ“š Documentation Validation
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}

    - name: ðŸ“ Validate Documentation
      run: |
        echo "Validating documentation files..."

        # VÃ©rifier la prÃ©sence des fichiers essentiels
        test -f README.md && echo "âœ… README.md present"
        test -f CHANGELOG.md && echo "âœ… CHANGELOG.md present"
        test -f LICENSE && echo "âœ… LICENSE present"
        test -f CONTRIBUTING.md && echo "âœ… CONTRIBUTING.md present"
        test -f EXAMPLES.md && echo "âœ… EXAMPLES.md present"
        test -f ARCHITECTURE.md && echo "âœ… ARCHITECTURE.md present"

        # VÃ©rifier que README n'est pas vide
        test -s README.md && echo "âœ… README.md is not empty"

        # VÃ©rifier les dÃ©finitions TypeScript
        test -f index.d.ts && echo "âœ… TypeScript definitions present"

        echo "ðŸ“š Documentation validation completed"

  # Job 5: Test de Performance et RÃ©gression
  performance:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: test

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: âš¡ Run Performance Benchmarks
      run: |
        echo "Running detailed performance analysis..."
        npm run benchmark > benchmark-output.txt

        # Analyser les rÃ©sultats de performance
        echo "Performance Analysis:"
        grep "ops/sec" benchmark-output.txt

        # VÃ©rifier que les performances sont acceptables
        echo "âœ… Performance benchmarks completed"

    - name: ðŸ“Š Save Performance Results
      uses: actions/upload-artifact@v4
      with:
        name: performance-results
        path: |
          benchmark-output.txt
          benchmark-results.json

  # Job 6: Test de CompatibilitÃ© Multi-OS
  compatibility:
    name: ðŸ–¥ï¸ Cross-Platform Compatibility
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: [16, 18, 20]

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ§ª Run Tests
      run: |
        npm test
        echo "âœ… Tests passed on ${{ matrix.os }} with Node.js ${{ matrix.node-version }}"

  # Job 7: Publication NPM (seulement sur release)
  publish:
    name: ðŸ“¦ Publish to NPM
    runs-on: ubuntu-latest
    needs: [test, coverage, security, docs, performance, compatibility]
    if: github.event_name == 'release' && github.event.action == 'published'

    steps:
    - name: ðŸ“¥ Checkout Code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        registry-url: 'https://registry.npmjs.org'

    - name: ðŸ“¦ Install Dependencies
      run: npm ci

    - name: ðŸ§ª Final Tests Before Publishing
      run: |
        npm test
        npm run benchmark
        echo "âœ… Pre-publish validation completed"

    - name: ðŸ—ï¸ Build Package
      run: |
        echo "Preparing package for publication..."
        npm pack --dry-run

    - name: ðŸ“¦ Publish to NPM
      run: |
        echo "Publishing to NPM..."
        npm publish
        echo "ðŸŽ‰ Package published successfully!"
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: ðŸ“¢ Create Release Summary
      run: |
        echo "## ðŸŽ‰ Release Summary" >> $GITHUB_STEP_SUMMARY
        echo "- Package: algorith@$(node -p "require('./package.json').version")" >> $GITHUB_STEP_SUMMARY
        echo "- Published to: https://www.npmjs.com/package/algorith" >> $GITHUB_STEP_SUMMARY
        echo "- Release: ${{ github.event.release.tag_name }}" >> $GITHUB_STEP_SUMMARY

  # Job 8: Notification et DÃ©ploiement
  notify:
    name: ðŸ“¢ Notifications & Cleanup
    runs-on: ubuntu-latest
    needs: [test, coverage, security, docs, performance, compatibility]
    if: always()

    steps:
    - name: ðŸ“Š Check Job Results
      run: |
        echo "## ðŸ“‹ Pipeline Results" >> $GITHUB_STEP_SUMMARY
        echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Coverage: ${{ needs.coverage.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Documentation: ${{ needs.docs.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Performance: ${{ needs.performance.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Compatibility: ${{ needs.compatibility.result }}" >> $GITHUB_STEP_SUMMARY

    - name: ðŸŽ‰ Success Notification
      if: ${{ needs.test.result == 'success' && needs.coverage.result == 'success' }}
      run: |
        echo "âœ… All checks passed! Ready for production." >> $GITHUB_STEP_SUMMARY

    - name: âŒ Failure Notification
      if: ${{ needs.test.result == 'failure' || needs.coverage.result == 'failure' }}
      run: |
        echo "âŒ Some checks failed. Please review the logs." >> $GITHUB_STEP_SUMMARY
